# 全本质量检查 Agent 使用说明

## 功能概述

全本质量检查 Agent 可以对已完成的小说进行**全面的质量检查**，并**自动生成优化后的版本**。

### 主要功能

1. **全本质量检查**：
   - 逐章质量检查（使用现有的 QualityChecker）
   - 全本连贯性检查（跨章节）
   - 角色一致性深度检查（全本）
   - 世界观一致性检查（全本）
   - 情节逻辑完整性检查
   - 风格统一性检查

2. **自动优化**（可选）：
   - 识别问题章节（问题数 >= 3 或高严重度）
   - 使用 LLM 自动优化问题章节
   - 生成优化后的完整小说
   - 保存优化对比报告

## 使用方法

### 基础检查（仅检查，不优化）

```bash
cd /root/data/AI/creator/src/task/novel
python3 full_novel_quality_agent.py \
    --novel_dir outputs/完美之墙 \
    --output outputs/完美之墙/full_quality_report.json
```

### 检查 + 自动优化

```bash
python3 full_novel_quality_agent.py \
    --novel_dir outputs/完美之墙 \
    --optimize \
    --output outputs/完美之墙/full_quality_report.json
```

## 输出结果

### 1. 检查报告 (`full_quality_report.json`)

包含完整的质量检查结果：

```json
{
  "check_time": "2026-01-24T...",
  "novel_title": "完美之墙",
  "total_chapters": 100,
  "auto_optimize": true,
  "overall_score": 0.96,
  "chapter_quality": {
    "1": {
      "total_issues": 1,
      "issues": [...],
      "has_high_severity": false
    },
    ...
  },
  "checks": {
    "coherence": {
      "score": 0.95,
      "issues": [...],
      "summary": "..."
    },
    "character_consistency": {...},
    "worldview_consistency": {...},
    "plot_integrity": {...},
    "style_consistency": {...}
  },
  "recommendations": [
    {
      "priority": "high",
      "type": "chapter_optimization",
      "description": "建议优化 X 个问题章节",
      "chapters": [1, 3, 5, ...],
      "action": "运行自动优化或手动修复"
    },
    ...
  ],
  "optimization": {
    "optimized_chapters": [1, 3, 5, ...],
    "optimized_count": 10,
    "failed_chapters": [],
    "optimization_details": {...}
  }
}
```

### 2. 优化后的章节（如果使用 `--optimize`）

- **目录**：`outputs/完美之墙/optimized/chapters/`
- **文件**：`chapter_001.txt`, `chapter_003.txt`, ...（仅优化的问题章节）

### 3. 优化后的完整小说（如果使用 `--optimize`）

- **文件**：`outputs/完美之墙/optimized/完美之墙_优化版.txt`
- **内容**：包含所有章节，优化后的章节使用新版本，未优化的章节使用原版本

## 检查维度详解

### 1. 逐章质量检查

对每章使用 `QualityChecker` 进行全面检查：
- 角色一致性
- 世界观一致性
- 时间线一致性
- 情节逻辑一致性
- 连贯性
- 对话质量
- 描写质量

### 2. 全本连贯性检查

- **角色连续性**：检查主要角色是否在相邻章节中连续出现
- **情节衔接**：检查章节间的逻辑衔接
- **时间线连贯**：检查时间顺序是否合理

### 3. 角色一致性深度检查

- **名称一致性**：检查角色名称在全本中是否保持一致
- **角色档案**：构建每个角色的完整档案（首次出现、出现章节等）
- **特征一致性**：检查角色特征描述是否一致

### 4. 世界观一致性检查

- **设定统一性**：检查世界观设定是否在全本中保持一致
- **规则一致性**：检查规则、法律等概念是否一致

### 5. 情节逻辑完整性检查

- **关键节点**：检查大纲中的关键情节节点是否在对应章节出现
- **伏笔回收**：检查伏笔是否得到回收（可扩展）
- **逻辑矛盾**：检查是否有情节逻辑矛盾

### 6. 风格统一性检查

- **对话占比**：统计每章对话占比，检查是否在合理范围（20-40%）
- **描写风格**：检查描写风格是否统一
- **节奏风格**：检查节奏是否统一

## 优化机制

### 优化触发条件

章节满足以下条件之一会被优化：
- **问题数 >= 3**
- **存在高严重度问题**

### 优化流程

1. **识别问题章节**：从检查报告中提取需要优化的章节
2. **生成优化提示词**：
   - 包含原章节内容
   - 列出检测到的问题
   - 提供优化建议
3. **LLM 优化**：使用 LLM（默认：kimi_k2）生成优化后的章节
4. **保存结果**：
   - 优化后的章节保存到 `optimized/chapters/`
   - 生成优化后的完整小说

### 优化限制

- 一次最多优化 **10 章**（避免成本过高）
- 每章最多处理 **3 个问题**（避免过度修改）

## 评分机制

总体评分 = 
- 连贯性得分 × 0.3
- 章节质量得分 × 0.4（基于平均问题数）
- 风格得分 × 0.2（基于风格问题数）
- 角色一致性得分 × 0.1（基于角色问题数）

## 使用建议

### 场景 1：发布前检查

```bash
# 仅检查，查看报告
python3 full_novel_quality_agent.py --novel_dir outputs/完美之墙
```

根据报告决定是否需要优化。

### 场景 2：自动优化

```bash
# 检查 + 自动优化
python3 full_novel_quality_agent.py --novel_dir outputs/完美之墙 --optimize
```

**注意**：
- 优化会消耗 LLM API 调用
- 优化后的章节需要人工审核
- 建议先检查报告，再决定是否优化

### 场景 3：批量优化

如果需要优化超过 10 章，可以：
1. 运行一次优化（优化前 10 章）
2. 手动修改代码中的限制
3. 或分多次运行

## 注意事项

1. **LLM 成本**：自动优化会消耗 LLM API 调用，请根据预算决定是否使用
2. **优化质量**：优化后的章节需要人工审核，确保质量
3. **备份原文件**：优化前建议备份原始章节文件
4. **语义网格**：如果存在 `semantic_mesh.json`，会用于更深入的检查

## 扩展功能

可以进一步扩展：
- 伏笔回收检查（需要更复杂的逻辑）
- 情节矛盾检测（使用 LLM 深度分析）
- 风格统一性深度检查（使用 LLM 分析文风）
- 批量优化所有问题章节（移除 10 章限制）

## 示例输出

```
============================================================
开始全本质量检查
模式：检查 + 自动优化
============================================================

加载完成：100 章
提取完成：156 个实体，12 个角色

[1/7] 逐章质量检查...
[2/7] 全本连贯性检查...
[3/7] 角色一致性深度检查...
[4/7] 世界观一致性检查...
[5/7] 情节逻辑完整性检查...
[6/7] 风格统一性检查...
[7/7] 生成优化建议...

============================================================
开始自动优化问题章节...
============================================================
需要优化的章节: [1, 3, 5, 9, 11, 13, 16, 18, 19, 23]
优化第1章...
第1章优化完成
优化第3章...
第3章优化完成
...
生成优化后的完整小说...

============================================================
全本质量检查完成！总体评分: 0.96/1.00
优化章节数: 10
============================================================
```
