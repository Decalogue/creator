"""
小说创作相关 prompt 模板。

供 task.novel 使用，集中管理便于调整与复用。
"""


def get_entity_extraction_prompt(text: str, max_chars: int = 2000) -> str:
    """实体提取 prompt：从章节文本中提取实体与关系。"""
    snippet = (text[:max_chars] + "...") if len(text) > max_chars else text
    return f"""请从以下小说章节中提取实体和关系。

章节内容：
{snippet}

请提取以下类型的实体：
1. 角色（Character）：人物姓名、称呼
2. 地点（Location）：地点名称、场所
3. 物品（Item/Symbol）：重要物品、道具
4. 概念（Concept）：重要概念、设定

请以 JSON 格式返回，格式如下：
{{
  "entities": [
    {{
      "name": "实体名称",
      "type": "character|location|item|concept",
      "description": "实体描述",
      "attributes": {{"key": "value"}}
    }}
  ],
  "relations": [
    {{
      "source": "实体1",
      "target": "实体2",
      "type": "appears_in|mentions|related_to|causes",
      "description": "关系描述"
    }}
  ]
}}
"""


JSON_REPAIR_PROMPT_TEMPLATE = """以下是一个格式错误的 JSON，请修复它并返回正确的 JSON 格式（只返回 JSON，不要其他内容）：

{json_str}

请确保：
1. 所有引号都是英文双引号
2. 没有尾随逗号
3. 字符串中的特殊字符已正确转义
4. JSON 结构完整且有效"""


DIALOGUE_QUALITY_INSTRUCTION = """
**对话质量要求（必须严格遵守）**：
1. **对话占比（硬性要求）**：对话必须占章节总字数的 20-40%，这是质量评估的核心指标
   - **最小值：20%**：如果对话占比低于20%，将被判定为质量问题
   - **理想范围：25-35%**：这是最佳对话占比，有助于平衡情节推进和人物展现
   - **最大值：40%**：如果对话占比超过40%，需要适当减少对话
   - **检查方法**：创作完成后，统计所有引号内的对话字数，确保占总字数的20-40%

2. **对话分布要求**：
   - 对话应均匀分布在整个章节中，不要集中在前半部分或后半部分
   - 每1000字至少包含3-5段对话
   - 避免连续多段纯描写而没有对话（超过200字必须有对话）

3. **对话功能**：每段对话都必须有明确目的
   - 推进情节：对话应该推动故事发展，而非仅仅交代信息
   - 展现人物：通过对话展现人物性格、关系、动机
   - 制造冲突：对话可以制造或激化冲突
   - 提供信息：必要的信息通过对话自然传达

4. **对话风格**：保持角色语言风格一致
   - 每个角色应有独特的说话方式（用词、语气、节奏）
   - 避免所有角色说话风格雷同
   - 对话应符合角色的身份、性格、教育背景

5. **对话技巧**：
   - 避免"信息转储"：不要通过对话大量交代背景信息
   - 使用潜台词：对话可以包含言外之意
   - 结合动作：对话必须配合动作、表情、环境描写，避免纯对话

**重要提示**：如果创作完成后发现对话占比不足20%，必须增加对话以达到要求。对话是小说质量的关键指标。
"""
