***REMOVED*** 自动回滚问题诊断报告

***REMOVED******REMOVED*** 问题描述
代码经常被自动回滚，导致优化后的代码丢失。

***REMOVED******REMOVED*** 根本原因
发现了一个 rsync 自动同步进程正在运行：

**进程路径**: `/var/lib/rsync/run.sh`
**同步周期**: 每 1000 秒（约 16.7 分钟）
**同步方向**: 本地 → 远程 (`root@azj1.dc.huixingyun.com:/root/data/`)
**危险选项**: `--delete`（会删除本地额外文件）

**关键问题**:
1. 如果远程服务器上的代码版本较旧，rsync 会**反向同步**回本地，覆盖新代码
2. `--delete` 选项会删除本地新增的文件
3. 同步是双向的，如果远程文件被修改，会同步回本地

***REMOVED******REMOVED*** 解决方案

***REMOVED******REMOVED******REMOVED*** 方案 1: 暂停/停止 rsync 同步（推荐用于开发期间）
```bash
***REMOVED*** 查找 rsync 进程
ps aux | grep rsync

***REMOVED*** 停止 rsync 进程
pkill -f "/var/lib/rsync/run.sh"

***REMOVED*** 或者暂停同步脚本的执行
```

***REMOVED******REMOVED******REMOVED*** 方案 2: 修改 rsync 脚本，排除工作目录
在 `/var/lib/rsync/run.sh` 中添加排除选项：
```bash
rsync -av --delete --exclude='/root/data/AI/creator/src/unimem/adapters/' \
  --progress -e "ssh ..." /root/data/ root@azj1.dc.huixingyun.com:/root/data/
```

***REMOVED******REMOVED******REMOVED*** 方案 3: 使用 Git 保护工作目录（最佳实践）
```bash
***REMOVED*** 确保代码及时提交到 Git
cd /root/data/AI/creator
git add src/unimem/adapters/
git commit -m "优化适配器代码"

***REMOVED*** 推送到远程仓库保护代码
git push origin main
```

***REMOVED******REMOVED******REMOVED*** 方案 4: 创建本地备份
在优化前创建备份：
```bash
cp -r /root/data/AI/creator/src/unimem/adapters /root/data/AI/creator/src/unimem/adapters.backup
```

***REMOVED******REMOVED******REMOVED*** 方案 5: 修改同步方向（如果需要继续同步）
如果确实需要从远程同步，应该：
1. 先确保远程代码是最新的
2. 修改同步脚本，使用 `--dry-run` 测试
3. 添加 `.git` 目录到排除列表（避免冲突）

***REMOVED******REMOVED*** 立即行动建议

1. **立即停止 rsync 同步**（开发期间）：
   ```bash
   pkill -f "/var/lib/rsync/run.sh"
   ```

2. **检查远程代码版本**：
   - 确认远程服务器上的代码是否较旧
   - 如果需要，先推送最新代码到远程

3. **提交当前优化到 Git**：
   ```bash
   cd /root/data/AI/creator
   git add src/unimem/adapters/
   git commit -m "适配器工业级优化：添加异常处理、线程安全、性能优化"
   git push origin main
   ```

4. **重新应用优化**：
   - 停止 rsync 后，重新运行优化脚本
   - 立即提交到 Git 保护代码

***REMOVED******REMOVED*** 预防措施

1. **开发前检查**：
   ```bash
   ps aux | grep rsync  ***REMOVED*** 检查是否有同步进程运行
   ```

2. **及时提交**：
   - 完成优化后立即提交到 Git
   - 使用分支保护重要更改

3. **监控文件变化**：
   ```bash
   watch -n 5 'git status src/unimem/adapters/'
   ```

***REMOVED******REMOVED*** 相关文件
- rsync 脚本: `/var/lib/rsync/run.sh`
- 工作目录: `/root/data/AI/creator/src/unimem/adapters/`

