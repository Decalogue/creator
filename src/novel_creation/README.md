***REMOVED*** 基于 ReAct 的中长篇小说创作系统

***REMOVED******REMOVED*** 概述

利用结合了 Cursor 和 Manus 思路的 ReAct 系统进行中长篇小说创作，充分利用以下特性：

- **工具动态发现**：Agent 可以主动查找工具文档
- **上下文缩减**：自动管理上下文，避免溢出
- **分层行动空间**：灵活使用 L1/L2/L3 工具
- **多 Agent 协作**：可选的多 Agent 协作模式

***REMOVED******REMOVED*** 设计思路

***REMOVED******REMOVED******REMOVED*** 1. 分章节创作

将长篇小说分解为多个章节，每章独立创作，降低上下文压力。

***REMOVED******REMOVED******REMOVED*** 2. 上下文管理

- 每章完成后进行 Compaction，保留关键信息
- 使用章节摘要确保前后章节连贯性
- 每5章进行一次上下文压缩

***REMOVED******REMOVED******REMOVED*** 3. 渐进式创作

支持边写边改，迭代优化。可以：
- 从任意章节开始续写
- 修改已有章节
- 调整大纲

***REMOVED******REMOVED*** 使用方法

***REMOVED******REMOVED******REMOVED*** 基本使用

```python
from novel_creation import ReactNovelCreator

***REMOVED*** 创建小说创作器
creator = ReactNovelCreator(
    novel_title="时空旅者的日记",
    enable_context_offloading=True
)

***REMOVED*** 创作小说
result = creator.create_novel(
    genre="科幻",
    theme="时间旅行、平行世界、人性探索",
    target_chapters=20,
    words_per_chapter=3000,
    start_from_chapter=1
)
```

***REMOVED******REMOVED******REMOVED*** 分步创作

```python
***REMOVED*** 1. 创建大纲
plan = creator.create_novel_plan(
    genre="科幻",
    theme="时间旅行",
    target_chapters=20,
    words_per_chapter=3000
)

***REMOVED*** 2. 创作单个章节
chapter = creator.create_chapter(
    chapter_number=1,
    chapter_title="第一章：起点",
    chapter_summary="主角发现时间旅行的秘密",
    target_words=3000
)

***REMOVED*** 3. 继续创作下一章
next_chapter = creator.create_chapter(
    chapter_number=2,
    chapter_title="第二章：第一次旅行",
    chapter_summary="主角进行第一次时间旅行",
    previous_chapters_summary=chapter.summary,  ***REMOVED*** 传递前面章节摘要
    target_words=3000
)
```

***REMOVED******REMOVED*** 输出结构

```
novel_creation/outputs/{novel_title}/
├── novel_plan.json          ***REMOVED*** 小说大纲
├── metadata.json            ***REMOVED*** 元数据
├── {novel_title}_完整版.txt ***REMOVED*** 完整小说
├── chapters/                ***REMOVED*** 章节文件
│   ├── chapter_001.txt
│   ├── chapter_001_meta.json
│   ├── chapter_002.txt
│   └── ...
├── summaries/               ***REMOVED*** 章节摘要
└── drafts/                  ***REMOVED*** 草稿
```

***REMOVED******REMOVED*** 特性

***REMOVED******REMOVED******REMOVED*** 1. 字数控制（基于番茄小说爆款数据统计）

- **目标字数**：2048字（完美落点）
- **允许范围**：1500-3000字
- **上限控制**：使用 `max_new_tokens` 在生成时控制长度
- **智能截断**：超过3000字时自动截断，保留核心情节

***REMOVED******REMOVED******REMOVED*** 2. 情节节奏控制

每章按照以下节奏结构创作：
- **开头（约25%）**：快速进入情节，引入本章核心冲突
- **发展（约40%）**：展开情节，推进冲突，展现人物
- **高潮（约25%）**：冲突达到顶点或出现转折
- **结尾（约10%）**：自然过渡，为下一章埋下伏笔

***REMOVED******REMOVED******REMOVED*** 3. 对话质量优化

- **对话占比**：20-40%（确保平衡）
- **对话功能**：推进情节、展现人物、制造冲突、提供信息
- **对话风格**：保持角色语言风格一致
- **对话技巧**：避免信息转储，使用潜台词，结合动作描写

***REMOVED******REMOVED******REMOVED*** 4. 上下文管理

- 自动使用 Context Offloading 管理上下文
- 每章完成后生成摘要，用于后续章节连贯性
- 每5章进行一次上下文压缩
- **分层摘要系统**：最近章节摘要、阶段摘要、关键节点摘要

***REMOVED******REMOVED******REMOVED*** 5. 章节连贯性

- 使用前面章节的摘要保持连贯性
- 自动检查人物性格一致性
- 保持情节逻辑连贯
- **实体管理系统**：
  - 实体重要性评分：根据出现频率和上下文重要性评分
  - 分层传递：重要实体优先传递到后续章节
  - **多模型投票提取**：使用多个LLM（gemini_3_flash + deepseek_v3_2）进行投票提取，精度95%+
  - 自动去重和合并相似实体

***REMOVED******REMOVED******REMOVED*** 6. 质量监控与优化

***REMOVED******REMOVED******REMOVED******REMOVED*** 6.1 单章质量检查

每章完成后自动进行全面的质量检查：

- **一致性检查**：角色一致性、世界观一致性、时间线一致性、情节逻辑一致性
- **对话质量检查**：
  - 对话占比（目标20-40%）
  - 对话目的（推进情节、展现人物、制造冲突）
  - 对话风格（角色语言风格一致性）
  - 对话与动作结合（避免纯对话堆砌）
- **描述质量检查**：
  - 冗余环境描述检测
  - 过度心理活动检测
  - 描述与情节推进的平衡

***REMOVED******REMOVED******REMOVED******REMOVED*** 6.2 阶段性质量检查

每10章进行一次综合质量评估：

- **连贯性得分**：章节间的逻辑连贯性
- **人物一致性得分**：人物性格、行为的一致性
- **情节节奏得分**：基于字数方差和对话比率的节奏评估
- **世界观一致性得分**：世界观设定的统一性
- **悬念得分**：使用 **LLM（deepseek_v3_2）** 进行智能评估
  - 评估维度：情节悬念、氛围营造、结尾设计、心理描写、信息控制
  - 相比关键词匹配，能更准确识别深层悬疑元素
- **综合评分**：综合所有维度（低于0.7时触发警告）

***REMOVED******REMOVED******REMOVED******REMOVED*** 6.3 自动重写机制

当检测到严重质量问题时会自动触发重写：

- **触发条件**：
  - 严重问题数 >= 1，或
  - 总问题数 >= 3
- **重写策略**：
  - 基于质量检查反馈构建重写提示词
  - 保持核心情节和主要事件不变
  - 解决检测到的质量问题
  - 重写后重新进行质量检查
- **效果追踪**：记录重写前后的质量对比

***REMOVED******REMOVED******REMOVED******REMOVED*** 6.4 动态调整机制

根据质量反馈动态调整后续章节的生成策略：

- **节奏问题调整**：当节奏得分 < 0.7 时，增强节奏控制指令
- **悬念问题调整**：当悬念得分 < 0.7 时，强化悬念设置要求
- **对话问题调整**：当对话占比或质量不达标时，优化对话要求
- **描述问题调整**：当检测到冗余描述或过度心理活动时，限制描述篇幅
- **一致性问题调整**：当检测到一致性问题时，强化一致性检查

***REMOVED******REMOVED******REMOVED******REMOVED*** 6.5 自适应生成策略

根据质量反馈自动调整生成参数：

- **连贯性增强**：当连贯性得分低时，增强连贯性检查
- **节奏控制**：当节奏得分低时，启用节奏控制
- **悬念控制**：当悬念得分低时，启用悬念控制
- **动态字数调整**：根据历史平均字数动态调整目标字数

***REMOVED******REMOVED******REMOVED*** 7. 渐进式大纲（100+章节）

- **整体大纲**：100-200章的整体故事框架
- **阶段大纲**：每20章一个阶段，详细规划
- **章节大纲**：每章的具体内容摘要
- 支持动态生成阶段大纲，避免一次性生成所有章节大纲

***REMOVED******REMOVED******REMOVED*** 8. 灵活创作

- 支持从任意章节开始续写
- 支持修改已有章节
- 支持调整大纲

***REMOVED******REMOVED*** 与 UniMem 的集成（未来）

当前版本不使用 UniMem，但设计上已考虑未来集成：

- 章节内容可以存储到 UniMem
- 人物信息可以存储到 UniMem
- 情节线索可以存储到 UniMem
- 使用 UniMem 检索相关章节和人物信息

***REMOVED******REMOVED*** 示例

运行示例脚本：

```bash
python novel_creation/example.py
```

***REMOVED******REMOVED*** 优化功能

***REMOVED******REMOVED******REMOVED*** Phase 1: 基础优化（已完成 ✅）

1. **字数控制**：基于番茄小说爆款数据统计，目标2048字，上限3000字
2. **实体管理系统**：实体重要性评分、分层传递、多模型投票提取
3. **渐进式大纲**：三层次大纲（整体、阶段、章节），支持100+章节
4. **分层摘要**：最近章节摘要、阶段摘要、关键节点摘要

***REMOVED******REMOVED******REMOVED*** Phase 2: 质量优化（已完成 ✅）

1. **情节节奏控制**：开头25%、发展40%、高潮25%、结尾10%
2. **对话质量优化**：对话占比20-40%，确保对话推进情节
3. **阶段性质量检查**：每10章自动评估综合质量（连贯性、人物一致性、节奏、世界观、悬念）

***REMOVED******REMOVED******REMOVED*** Phase 3: 高级优化（已完成 ✅）

1. **质量指标追踪**：持续追踪所有质量指标（字数、对话占比、质量问题等）
2. **LLM悬念评估**：使用 deepseek_v3_2 进行智能悬念得分评估，替代关键词匹配
3. **章节重写机制**：基于质量反馈自动重写问题章节
4. **动态调整指令**：根据质量问题类型（节奏、悬念、对话、描述、一致性）动态调整后续章节prompt
5. **自适应生成策略**：根据质量反馈自动调整生成参数和策略
6. **质量追踪系统**：完整记录每章的质量指标，支持质量趋势分析

***REMOVED******REMOVED******REMOVED*** Phase 4: 持续优化（进行中 🔄）

1. **大纲动态调整**：根据实际创作情况调整后续大纲
2. **主题适配优化**：针对不同主题（悬疑、治愈、科幻等）优化生成策略
3. **重写机制优化**：提升重写效果，确保重写后问题显著减少

***REMOVED******REMOVED*** 测试结果

***REMOVED******REMOVED******REMOVED*** 阶段性质量检查示例（12章测试）

```json
{
  "chapter_range": "第1-10章",
  "scores": {
    "coherence": 1.00,
    "character_consistency": 1.00,
    "plot_rhythm": 0.60,
    "worldview_consistency": 1.00,
    "suspense": 0.80,
    "overall": 0.90
  },
  "needs_attention": false
}
```

**评分说明**：
- 综合评分 0.90（优秀）
- 连贯性、人物一致性、世界观一致性均为满分
- 节奏得分 0.60（需要改进，章节长度变化较小）
- 悬念得分 0.80（良好，使用LLM评估）

**质量优化效果**：
- 系统会自动检测到节奏和悬念问题
- 动态调整后续章节的生成策略
- 问题章节会自动触发重写机制
- 质量指标持续追踪，支持趋势分析

***REMOVED******REMOVED*** LLM 配置

系统采用混合模型策略，根据任务特点选择最适合的模型（基于实际对比测试结果）：

- **章节生成**：默认使用 `gemini_3_flash`（字数控制更准确，初始质量问题更少）
  - 可通过环境变量 `NOVEL_LLM_MODEL` 或 `llm_client` 参数指定
  - 推荐：`gemini_3_flash`（测试显示：字数差异27.1% vs 135.9%，问题数1.30 vs 2.40个/章）
- **重写机制**：使用章节生成相同的模型（`gemini_3_flash`）
  - 测试显示改善率更高（60.0% vs 57.1%）
- **悬念评估**：固定使用 `deepseek_v3_2` 进行智能评估
  - 更适合深度理解和分析任务
- **实体提取**：使用多模型投票（`gemini_3_flash` + `deepseek_v3_2`）
  - 两个模型互补，提高提取精度（95%+）
- **质量检查**：基于规则的检查系统，不直接使用LLM
  - 检查一致性、连贯性、风格等问题

***REMOVED******REMOVED*** 注意事项

1. **LLM 配置**：确保 `react.py` 中的 LLM 配置正确，支持通过环境变量 `NOVEL_LLM_MODEL` 指定模型
2. **上下文长度**：长篇小说创作时注意上下文长度管理，系统会自动进行压缩
3. **创作质量**：系统自动进行质量检查，每10章生成质量报告，问题章节会自动重写
4. **资源消耗**：长篇小说创作需要较多 Token，注意成本控制
   - 悬念评估：每5章评估一次，每次调用 deepseek_v3_2
   - 重写机制：仅在检测到严重问题时触发
5. **字数控制**：虽然目标2048字，但实际可能在2500-3000字之间（符合番茄小说统计建议）
6. **质量优化**：系统会自动根据质量反馈调整后续章节，无需手动干预